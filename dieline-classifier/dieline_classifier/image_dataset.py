import pandas as pd

CSV_FILENAME = "data/features.csv"
HDF_FILENAME = "data/features-images.h5"

class ImageDataset:
    """
    Class that holds the image based dieline dataset.
    """

    def __init__(self, reprocess_data: bool) -> None:
        """
        Loads the image dieline dataset. If reprocess_data is true, the data
        is loaded from the CSV file and cached in an HDF file; otherwise, it
        is loaded from the HDF file.
        """

        if reprocess_data: 
            # Read from CSV and generate HDF.
            self._from_csv(CSV_FILENAME, 0.8, HDF_FILENAME)
        else:
            # Read from HDF.
            self._from_hdf(HDF_FILENAME)

    def _from_csv(self, csv_filename: str, train_fraction: float,
        hdf_filename: str) -> None:
        """
        Pre-processes image data. Only needs to be called once.
        """

        # Read the raw data.
        df = pd.read_csv(csv_filename)

        # Randomize the rows of the data frame, in place.
        df = df.sample(frac=1).reset_index(drop=True)

        # Create a new dataframe that just has the image filenames and the
        # category labels.
        filenames = df.apply(lambda row: f"{row['Directory']}--{row['Filename']}--{row['Face index']}.png", axis=1)
        filenames.name = 'Filename'
        categories = df['Category']
        new_df = pd.concat([filenames, categories], axis=1)

        # Split data into train and test sets, and save to hdf file.
        num_rows = new_df.shape[0]

        train_len = int(train_fraction * num_rows)

        self.train = new_df[0 : train_len]
        self.test = new_df[train_len : ]
        self.categories = pd.Series(sorted(set(categories)))
        
        self.train.to_hdf(hdf_filename, key="train", mode="w")
        self.test.to_hdf(hdf_filename, key="test")
        self.categories.to_hdf(hdf_filename, key="categories")

    def _from_hdf(self, hdf_filename: str) -> None:
        """
        Reads the data generated by _from_csv.
        """

        self.train = pd.read_hdf(hdf_filename, "train")
        self.test = pd.read_hdf(hdf_filename, "test")
        self.categories = pd.read_hdf(hdf_filename, "categories")
